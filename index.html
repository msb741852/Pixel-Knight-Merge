<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Knight: Infinite Clicker</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #2c3e50;
            --panel-bg: #34495e;
            --slot-bg: #202d3a;
            --accent: #e74c3c;
            --gold: #f1c40f;
            --text: #ecf0f1;
            --pixel-font: 'Press Start 2P', cursive;
        }

        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color); color: var(--text);
            font-family: var(--pixel-font);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- UI Components --- */
        /* 1. Login Modal */
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #login-modal input {
            padding: 15px; font-family: inherit; font-size: 1.2rem; text-align: center; 
            margin-bottom: 20px; width: 80%; max-width: 300px; text-transform: uppercase;
            border: 4px solid #fff; background: #000; color: #fff;
        }
        
        /* 2. Rank Overlay */
        #rank-overlay { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 350px; background: #222; border: 4px solid #fff; padding: 20px; 
            z-index: 9000; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        #rank-btn { 
            position: absolute; top: 10px; right: 10px; z-index: 50; 
            padding: 8px 12px; font-size: 0.8rem; background: #222; 
            border: 2px solid gold; color: gold; cursor: pointer; 
        }

        /* 3. Stage Area (Battle) */
        #stage-area {
            flex: 0 0 40%; background: #87CEEB; position: relative; 
            overflow: hidden; border-bottom: 4px solid #000; 
            image-rendering: pixelated; cursor: crosshair; /* Ï°∞Ï§ÄÏ†ê Ïª§ÏÑú */
        }
        .stage-ui {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between; z-index: 20;
            text-shadow: 2px 2px 0 #000; font-size: 0.7rem; color: #fff; pointer-events: none;
        }
        
        /* Background Elements */
        .sky-cloud {
            position: absolute; top: 20px; width: 60px; height: 20px;
            background: #fff; box-shadow: 10px 10px 0 #eee; opacity: 0.8;
            animation: cloudMove 20s linear infinite; pointer-events: none;
        }
        .ground {
            position: absolute; bottom: 0; width: 100%; height: 20%;
            background: #27ae60; border-top: 4px solid #2ecc71; pointer-events: none;
        }
        @keyframes cloudMove { from { left: 100%; } to { left: -20%; } }

        /* Actors (Hero & Monster) */
        .actor-wrapper { position: absolute; bottom: 15%; width: 80px; height: 80px; pointer-events: none; }
        svg { width: 100%; height: 100%; overflow: visible; }

        #hero-wrapper { left: 15%; z-index: 10; }
        .hero-idle { animation: idleBounce 0.8s infinite alternate; }
        .hero-attack { animation: attackThrust 0.1s forwards; } /* Í≥µÍ≤© ÏÜçÎèÑ Îß§Ïö∞ Îπ†Î¶Ñ */
        @keyframes idleBounce { to { transform: translateY(-3px); } }
        @keyframes attackThrust { 0% { transform: translateX(0); } 50% { transform: translateX(20px); } 100% { transform: translateX(0); } }

        #monster-wrapper { right: 15%; z-index: 9; transition: filter 0.05s; }
        .monster-idle { animation: monsterFloat 1.5s infinite ease-in-out; }
        .monster-hit { filter: brightness(10) sepia(1) saturate(5) hue-rotate(-50deg) !important; transform: scale(0.9); }
        @keyframes monsterFloat { 50% { transform: translateY(-5px) scale(1.05); } }

        /* HP Bar */
        .hp-bar-container {
            position: absolute; bottom: 85px; right: 15%; width: 80px; height: 8px;
            background: #333; border: 2px solid #000; pointer-events: none;
        }
        .hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.1s; }

        /* Damage Text */
        .dmg-text {
            position: absolute; font-weight: bold; text-shadow: 2px 2px 0 #000;
            pointer-events: none; animation: floatUp 0.6s forwards; z-index: 100;
        }
        @keyframes floatUp { 
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
        }

        /* 4. Game Area (Merge) */
        #game-area {
            flex: 1; display: flex; flex-direction: column; padding: 10px;
            background: var(--panel-bg); box-shadow: inset 0 5px 10px rgba(0,0,0,0.3);
        }
        .stats-bar {
            display: flex; justify-content: space-between; margin-bottom: 10px;
            font-size: 0.8rem; color: var(--gold); text-shadow: 1px 1px 0 #000;
        }
        #grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;
            flex: 1; max-width: 500px; margin: 0 auto; width: 100%; aspect-ratio: 1;
        }
        .slot {
            background: var(--slot-bg); border: 2px solid #111; border-radius: 4px;
            position: relative; display: flex; justify-content: center; align-items: center;
        }
        .item {
            font-size: 2rem; cursor: grab; position: absolute; z-index: 5;
            filter: drop-shadow(2px 2px 0 #000); transition: transform 0.1s;
        }
        .item.dragging { z-index: 100; pointer-events: none; transform: scale(1.2); opacity: 0.8; }

        /* Controls */
        .controls { margin-top: 10px; text-align: center; }
        button {
            background: var(--accent); color: white; border: 4px solid #c0392b; padding: 15px;
            font-family: var(--pixel-font); font-size: 1rem; width: 100%; max-width: 500px;
            box-shadow: 0 4px 0 #96281b; cursor: pointer; text-transform: uppercase;
        }
        button:active { transform: translateY(4px); box-shadow: none; }
        button:disabled { background: #7f8c8d; border-color: #555; box-shadow: none; color: #ccc; cursor: not-allowed; }
        
        .modal-btn { width: auto; margin-top: 10px; padding: 10px 20px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="login-modal">
        <h1 style="color:white; text-shadow: 4px 4px 0 #000; margin-bottom: 30px; text-align: center; line-height: 1.5;">PIXEL<br>KNIGHT</h1>
        <input type="text" id="nickname-input" placeholder="NICKNAME (ENG)" maxlength="8">
        <button onclick="checkAndStart()" style="width: 80%; max-width: 300px;">GAME START</button>
        <p id="login-msg" style="color: #ff6b6b; font-size: 0.7rem; margin-top: 15px; height: 10px;"></p>
        <p style="color: #ccc; font-size: 0.6rem; margin-top: 30px;">SOUND ON üîä</p>
    </div>

    <button id="rank-btn" onclick="openRanking()">üèÜ RANK</button>
    <div id="rank-overlay">
        <h3 style="color: gold; margin-top: 0;">HALL OF FAME</h3>
        <div id="rank-list" style="text-align: left; font-size: 0.8rem; line-height: 1.8; min-height: 150px; color: white; margin-bottom: 20px;">
            Loading...
        </div>
        <button class="modal-btn" onclick="document.getElementById('rank-overlay').style.display='none'">CLOSE</button>
    </div>

    <div id="stage-area">
        <div class="sky-cloud"></div>
        <div class="ground"></div>
        <div class="stage-ui">
            <div>‚öîÔ∏è DPS: <span id="dps-display">0</span></div>
            <div>üö© STAGE <span id="stage-num">1</span></div>
        </div>
        
        <div id="hero-wrapper" class="actor-wrapper hero-idle">
            <svg viewBox="0 0 12 12" shape-rendering="crispEdges">
                <rect x="5" y="0" width="2" height="1" fill="#e74c3c" />
                <rect x="4" y="1" width="4" height="3" fill="#95a5a6" />
                <rect x="5" y="2" width="2" height="1" fill="#000" />
                <rect x="3" y="4" width="6" height="4" fill="#34495e" />
                <rect x="5" y="5" width="2" height="2" fill="#bdc3c7" />
                <rect x="4" y="8" width="1" height="3" fill="#2c3e50" />
                <rect x="7" y="8" width="1" height="3" fill="#2c3e50" />
                <rect x="9" y="5" width="1" height="1" fill="#8e44ad" />
                <rect x="9" y="2" width="1" height="3" fill="#ecf0f1" />
                <rect x="2" y="5" width="2" height="3" fill="#f1c40f" />
            </svg>
        </div>

        <div id="monster-wrapper" class="actor-wrapper monster-idle">
            <div class="hp-bar-container"><div id="monster-hp-bar" class="hp-fill"></div></div>
            <svg id="monster-svg" viewBox="0 0 12 12" shape-rendering="crispEdges">
                <rect x="2" y="4" width="8" height="7" fill="currentColor" />
                <rect x="3" y="3" width="6" height="1" fill="currentColor" />
                <rect x="3" y="5" width="2" height="2" fill="#fff" />
                <rect x="7" y="5" width="2" height="2" fill="#fff" />
                <rect x="4" y="6" width="1" height="1" fill="#000" />
                <rect x="8" y="6" width="1" height="1" fill="#000" />
                <rect x="5" y="9" width="2" height="1" fill="#330000" opacity="0.5" />
            </svg>
        </div>
    </div>

    <div id="game-area">
        <div class="stats-bar">
            <span>üí∞ <span id="gold-display">0</span></span>
            <span id="my-nick-display" style="color: #aaa;">PLAYER</span>
        </div>
        <div id="grid"></div>
        <div class="controls">
            <button id="buy-btn">WEAPON (10 G)</button>
            <div style="margin-top:8px; font-size:0.6rem; color:#7f8c8d; cursor:pointer;" onclick="resetData()">[RESET DATA]</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, limit, getDocs } 
          from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAv0ZL9zviZYaHINFpX0j7kkwlB7SvcMzM",
          authDomain: "pixel-merge-game.firebaseapp.com",
          projectId: "pixel-merge-game",
          storageBucket: "pixel-merge-game.firebasestorage.app",
          messagingSenderId: "655295451453",
          appId: "1:655295451453:web:ae0d1fc35d02f992ecf554"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Ï†ÑÏó≠ Î≥ÄÏàò ---
        window.myNickname = localStorage.getItem('pixelNick') || null;
        let game = { gold: 0, inventory: Array(16).fill(null), buyCount: 0, stage: 1, monsterHp: 20, maxHp: 20, bestStage: 1 };
        const WEAPONS = ['üó°Ô∏è', '‚öîÔ∏è', 'üèπ', 'ü™ì', 'üî±', 'üî•', 'üíÄ', 'üíé', 'üåô', 'üåü'];
        let audioCtx = null;
        let isGameStarted = false;

        // --- 1. Î°úÍ∑∏Ïù∏ & Îû≠ÌÇπ ÏãúÏä§ÌÖú ---
        const loginModal = document.getElementById('login-modal');
        const loginMsg = document.getElementById('login-msg');

        // Ïù¥ÎØ∏ ÎãâÎÑ§ÏûÑÏù¥ ÏûàÏúºÎ©¥ Î∞îÎ°ú ÏãúÏûë
        if (window.myNickname) {
            loginModal.style.display = 'none';
            // ÏûêÎèô ÏãúÏûë ÏãúÏóêÎäî ÏÇ¨Ïö¥Îìú Ïª®ÌÖçÏä§Ìä∏Í∞Ä user gestureÎ•º Í∏∞Îã§Î†§Ïïº ÌïòÎØÄÎ°ú
            // Ï≤´ ÌÅ¥Î¶≠(Ï†ÑÌà¨) Ïãú Ïò§ÎîîÏò§Í∞Ä ÏºúÏßÄÎèÑÎ°ù Ï≤òÎ¶¨Îê®
            startGame();
        }

        window.checkAndStart = async () => {
            const input = document.getElementById('nickname-input').value.trim().toUpperCase();
            if (input.length < 2) {
                loginMsg.innerText = "2Í∏ÄÏûê Ïù¥ÏÉÅ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.";
                return;
            }

            // Ï§ëÎ≥µ Ï≤¥ÌÅ¨
            const docRef = doc(db, "ranks", input);
            try {
                loginMsg.innerText = "CHECKING...";
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && input !== window.myNickname) {
                    loginMsg.innerText = "Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÎãâÎÑ§ÏûÑÏûÖÎãàÎã§.";
                } else {
                    localStorage.setItem('pixelNick', input);
                    window.myNickname = input;
                    // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                    if (!docSnap.exists()) {
                        await setDoc(docRef, { score: 1, lastUpdate: new Date().toISOString() });
                    }
                    
                    loginModal.style.display = 'none';
                    initAudio(); // Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ïò§ÎîîÏò§ ÌôúÏÑ±Ìôî
                    startGame();
                }
            } catch (e) {
                console.error(e);
                loginMsg.innerText = "ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïò§Î•ò (Config ÌôïÏù∏)";
            }
        };

        // ÏûêÎèô Îû≠ÌÇπ Ï†ÄÏû• (Ïã†Í∏∞Î°ù Îã¨ÏÑ± Ïãú)
        async function autoSaveScore() {
            if (!window.myNickname) return;
            if (game.stage > game.bestStage) {
                game.bestStage = game.stage;
                try {
                    await setDoc(doc(db, "ranks", window.myNickname), { 
                        score: game.stage, 
                        lastUpdate: new Date().toISOString() 
                    }, { merge: true });
                } catch(e) {}
            }
        }

        window.openRanking = async () => {
            document.getElementById('rank-overlay').style.display = 'block';
            const listEl = document.getElementById('rank-list');
            listEl.innerHTML = "Loading...";

            try {
                const q = query(collection(db, "ranks"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                let html = "";
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let color = 'white';
                    if (rank === 1) color = '#ffd700'; // Gold
                    else if (rank === 2) color = '#c0c0c0'; // Silver
                    else if (rank === 3) color = '#cd7f32'; // Bronze

                    html += `<div style="display:flex; justify-content:space-between; color:${color}; margin-bottom: 5px; border-bottom:1px solid #333;">
                                <span>${rank}. ${doc.id}</span>
                                <span>${data.score} F</span>
                             </div>`;
                    rank++;
                });
                listEl.innerHTML = html;
            } catch(e) {
                listEl.innerHTML = "Error loading rank.<br>Check console.";
                console.error(e);
            }
        }

        // --- 2. ÏÇ¨Ïö¥Îìú ÏãúÏä§ÌÖú (Web Audio API) ---
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playSfx(type) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            
            if (type === 'hit') { // ÌçΩ! (Noise-like)
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'click') { // Ïñç! (Higher pitch)
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'merge') { // Îù†Î°±
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'buy') { // Ïß§Îûë
                osc.type = 'square';
                osc.frequency.setValueAtTime(1200, now);
                gainNode.gain.setValueAtTime(0.05, now);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            }
        }

        // --- 3. Í≤åÏûÑ ÏΩîÏñ¥ Î°úÏßÅ ---
        function startGame() {
            document.getElementById('my-nick-display').innerText = window.myNickname || 'PLAYER';
            isGameStarted = true;
            initGrid();
            loadData();
            render();
            requestAnimationFrame(combatLoop);
        }

        // Ïú†Ìã∏ Ìï®Ïàò
        function getBuyCost() { return Math.floor(10 * Math.pow(1.15, game.buyCount)); }
        function getWeaponDamage(level) { return Math.floor(10 * Math.pow(2.1, level)); }
        function getTotalDPS() { return game.inventory.reduce((sum, lvl) => (lvl !== null ? sum + getWeaponDamage(lvl) : sum), 0); }
        function getMonsterMaxHp(stage) { return Math.floor(30 * Math.pow(1.25, stage - 1)); }

        // --- Ï†ÑÌà¨ ÏãúÏä§ÌÖú (ÏûêÎèô + ÌÅ¥Î¶≠) ---
        let lastTime = 0;
        function combatLoop(timestamp) {
            if (!isGameStarted) return;
            if (!lastTime) lastTime = timestamp;
            if (timestamp - lastTime >= 1000) { // 1Ï¥àÎßàÎã§ ÏûêÎèô Í≥µÍ≤©
                const dps = getTotalDPS();
                if (dps > 0) attackMonster(dps, null, null, false);
                lastTime = timestamp;
            }
            requestAnimationFrame(combatLoop);
        }

        // ÌÅ¥Î¶≠/ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ (Ï†ÑÌà¨ ÏòÅÏó≠)
        const stageZone = document.getElementById('stage-area');
        stageZone.addEventListener('pointerdown', (e) => {
            if (!isGameStarted || game.monsterHp <= 0) return;
            initAudio(); // Ï≤´ ÌÅ¥Î¶≠ Ïãú Ïò§ÎîîÏò§ ÌôúÏÑ±Ìôî Î≥¥Ïû•
            
            // ÌÅ¥Î¶≠ Îç∞ÎØ∏ÏßÄ = DPS (DPSÍ∞Ä 0Ïù¥Ïñ¥ÎèÑ ÏµúÏÜå 1 Îç∞ÎØ∏ÏßÄ)
            const dps = getTotalDPS();
            const dmg = Math.max(1, dps); 
            
            attackMonster(dmg, e.clientX, e.clientY, true);
        });

        function attackMonster(damage, x, y, isClick) {
            const hero = document.getElementById('hero-wrapper');
            const monster = document.getElementById('monster-wrapper');

            // Hero Animation (Reset for instant feedback)
            hero.classList.remove('hero-attack');
            void hero.offsetWidth; 
            hero.classList.add('hero-attack');

            // Monster Damage
            game.monsterHp -= damage;
            updateHpBar();
            
            // Visual & Sound
            showDamageText(damage, x, y, isClick);
            if (isClick) playSfx('click'); 
            else playSfx('hit');

            // Monster Hit Effect
            monster.classList.remove('monster-hit');
            void monster.offsetWidth;
            monster.classList.add('monster-hit');

            // Death Check
            if (game.monsterHp <= 0) killMonster();
        }

        function killMonster() {
            game.gold += Math.floor(game.maxHp * 0.4);
            game.stage++;
            game.maxHp = getMonsterMaxHp(game.stage);
            game.monsterHp = game.maxHp;

            autoSaveScore(); // Ïä§ÌÖåÏù¥ÏßÄ ÌÅ¥Î¶¨Ïñ¥ Ïãú ÏûêÎèô Ï†ÄÏû•
            
            updateMonsterAppearance();
            updateHpBar();
            render();
        }

        function showDamageText(dmg, x, y, isClick) {
            const el = document.createElement('div');
            el.className = 'dmg-text';
            el.innerHTML = isClick ? `üí•${dmg}` : `-${dmg}`;
            
            // ÌÅ¥Î¶≠ÏùÄ ÎÖ∏ÎûÄÏÉâ ÌÅ¨Í≤å, ÏûêÎèôÏùÄ Ìù∞ÏÉâ ÏûëÍ≤å
            el.style.color = isClick ? '#fff176' : '#fff'; 
            el.style.fontSize = isClick ? '1.5rem' : '1.0rem';
            el.style.zIndex = 100;

            if (x !== null && y !== null) {
                el.style.left = `${x}px`; el.style.top = `${y}px`;
            } else {
                // Î™¨Ïä§ÌÑ∞ Í∑ºÏ≤ò ÎûúÎç§
                const mRect = document.getElementById('monster-wrapper').getBoundingClientRect();
                const rX = (Math.random() - 0.5) * 60;
                el.style.left = `${mRect.left + 30 + rX}px`;
                el.style.top = `${mRect.top}px`;
            }
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        function updateHpBar() {
            const pct = Math.max(0, (game.monsterHp / game.maxHp) * 100);
            document.getElementById('monster-hp-bar').style.width = pct + '%';
        }
        
        function updateMonsterAppearance() {
            const hue = (game.stage * 35) % 360; 
            const monster = document.getElementById('monster-wrapper');
            monster.style.color = `hsl(${hue}, 70%, 60%)`;
            document.getElementById('monster-svg').style.fill = `hsl(${hue}, 70%, 60%)`;
        }

        // --- 4. Î®∏ÏßÄ & Î†åÎçîÎßÅ ---
        function initGrid() {
            const gridEl = document.getElementById('grid');
            gridEl.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                let slot = document.createElement('div');
                slot.className = 'slot'; slot.dataset.index = i;
                gridEl.appendChild(slot);
            }
        }

        function render() {
            document.getElementById('gold-display').innerText = Math.floor(game.gold).toLocaleString();
            document.getElementById('dps-display').innerText = getTotalDPS().toLocaleString();
            document.getElementById('stage-num').innerText = game.stage;
            
            const cost = getBuyCost();
            const buyBtn = document.getElementById('buy-btn');
            buyBtn.innerText = `WEAPON (${cost.toLocaleString()} G)`;
            buyBtn.disabled = game.gold < cost;

            const slots = document.querySelectorAll('.slot');
            slots.forEach((slot, idx) => {
                if (slot.querySelector('.dragging')) return;
                slot.innerHTML = '';
                const level = game.inventory[idx];
                if (level !== null) {
                    const el = document.createElement('div'); el.className = 'item';
                    el.innerText = WEAPONS[level] || 'üëë';
                    addDragEvents(el); slot.appendChild(el);
                }
            });
            saveData();
        }

        // Drag & Drop
        let dragged = null, startIdx = null, offsets = { x:0, y:0 };
        function addDragEvents(el) { 
            el.addEventListener('mousedown', startDrag); 
            el.addEventListener('touchstart', startDrag, {passive: false}); 
        }
        function startDrag(e) {
            if(e.type === 'touchstart') e.preventDefault(); // Î™®Î∞îÏùº Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ
            dragged = e.target; startIdx = parseInt(dragged.parentElement.dataset.index);
            const cX = e.touches ? e.touches[0].clientX : e.clientX; 
            const cY = e.touches ? e.touches[0].clientY : e.clientY;
            const r = dragged.getBoundingClientRect(); 
            offsets.x = cX - r.left; offsets.y = cY - r.top;
            
            dragged.classList.add('dragging'); 
            dragged.style.position = 'fixed';
            dragged.style.left = (cX - offsets.x) + 'px'; dragged.style.top = (cY - offsets.y) + 'px';
            dragged.style.width = r.width + 'px'; dragged.style.height = r.height + 'px';
            
            document.addEventListener('mousemove', moveDrag); document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', moveDrag, {passive:false}); document.addEventListener('touchend', endDrag);
        }
        function moveDrag(e) { 
            if(!dragged) return; if(e.type === 'touchmove') e.preventDefault();
            const cX = e.touches ? e.touches[0].clientX : e.clientX; 
            const cY = e.touches ? e.touches[0].clientY : e.clientY; 
            dragged.style.left = (cX - offsets.x) + 'px'; dragged.style.top = (cY - offsets.y) + 'px'; 
        }
        function endDrag(e) {
            if(!dragged) return; 
            const cX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX; 
            const cY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            
            dragged.hidden = true; 
            const elem = document.elementFromPoint(cX, cY); 
            dragged.hidden = false;
            
            const slot = elem ? elem.closest('.slot') : null; 
            if(slot) handleMerge(startIdx, parseInt(slot.dataset.index));
            
            dragged.remove(); dragged = null;
            document.removeEventListener('mousemove', moveDrag); document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', moveDrag); document.removeEventListener('touchend', endDrag); 
            render();
        }

        function handleMerge(from, to) {
            if(from === to) return; 
            const i1 = game.inventory[from], i2 = game.inventory[to];
            
            if(i2 === null) { // Ïù¥Îèô
                game.inventory[to] = i1; game.inventory[from] = null; 
            } else if(i1 === i2) { // Ìï©ÏπòÍ∏∞
                if(i1 < WEAPONS.length - 1) { 
                    game.inventory[to] = i1 + 1; game.inventory[from] = null; 
                    playSfx('merge');
                } else { // ÎßåÎ†ô ÍµêÏ≤¥
                    game.inventory[to] = i1; game.inventory[from] = i2; 
                } 
            } else { // ÍµêÏ≤¥
                game.inventory[to] = i1; game.inventory[from] = i2; 
            }
        }

        document.getElementById('buy-btn').addEventListener('click', () => {
            const cost = getBuyCost(); const empty = game.inventory.findIndex(x => x === null);
            if(game.gold >= cost && empty !== -1) { 
                game.gold -= cost; game.inventory[empty] = 0; game.buyCount++; 
                playSfx('buy'); render(); 
            }
        });

        // Save & Load
        function saveData() { localStorage.setItem('knightMergeSave', JSON.stringify(game)); }
        function loadData() { 
            const s = localStorage.getItem('knightMergeSave'); 
            if(s) { 
                game = JSON.parse(s); 
                if(!game.bestStage) game.bestStage = game.stage; // Íµ¨Î≤ÑÏ†Ñ Îç∞Ïù¥ÌÑ∞ Ìò∏Ìôò
            } else {
                game.gold = 100; // Ï¥àÍ∏∞ ÏûêÍ∏à
            }
            updateMonsterAppearance(); 
        }
        
        window.resetData = function() { 
            if(confirm("Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { 
                localStorage.removeItem('knightMergeSave'); 
                localStorage.removeItem('pixelNick'); 
                location.reload(); 
            } 
        }
    </script>
</body>
</html>