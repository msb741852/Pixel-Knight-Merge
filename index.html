<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Knight Merge + Sound</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #2c3e50;
            --panel-bg: #34495e;
            --slot-bg: #202d3a;
            --accent: #e74c3c;
            --gold: #f1c40f;
            --text: #ecf0f1;
            --pixel-font: 'Press Start 2P', cursive;
        }
        * { box-sizing: border-box; touch-action: none; }
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color); color: var(--text);
            font-family: var(--pixel-font);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; user-select: none;
        }

        /* --- ì‹œì‘ í™”ë©´ (ì˜¤ë²„ë ˆì´) --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 9999;
        }
        .start-btn {
            padding: 20px 40px; font-size: 1.5rem;
            background: var(--accent); color: white; border: 4px solid #fff;
            cursor: pointer; animation: pulse 1s infinite;
            font-family: var(--pixel-font);
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- ì‚¬ìš´ë“œ ì»¨íŠ¸ë¡¤ --- */
        #sound-toggle {
            position: absolute; top: 10px; right: 10px;
            z-index: 100; font-size: 1.5rem; cursor: pointer;
            text-shadow: 2px 2px 0 #000;
        }

        /* --- ìƒë‹¨ ì „íˆ¬ í™”ë©´ --- */
        #stage-area {
            flex: 0 0 40%; background: #87CEEB; position: relative;
            overflow: hidden; border-bottom: 4px solid #000;
            image-rendering: pixelated;
        }
        .sky-cloud {
            position: absolute; top: 20px; width: 60px; height: 20px;
            background: #fff; box-shadow: 10px 10px 0 #eee; opacity: 0.8;
            animation: cloudMove 20s linear infinite;
        }
        .ground {
            position: absolute; bottom: 0; width: 100%; height: 20%;
            background: #27ae60; border-top: 4px solid #2ecc71;
        }
        @keyframes cloudMove { from { left: 100%; } to { left: -20%; } }
        
        .stage-ui {
            position: absolute; top: 10px; left: 10px; right: 50px;
            display: flex; justify-content: space-between; z-index: 20;
            text-shadow: 2px 2px 0 #000; font-size: 0.7rem; color: #fff;
        }

        /* ìºë¦­í„°/ëª¬ìŠ¤í„° wrapper */
        .actor-wrapper { position: absolute; bottom: 15%; width: 80px; height: 80px; }
        svg { width: 100%; height: 100%; overflow: visible; }

        #hero-wrapper { left: 15%; z-index: 10; }
        .hero-idle { animation: idleBounce 0.8s infinite alternate; }
        .hero-attack { animation: attackThrust 0.15s forwards; }
        @keyframes idleBounce { to { transform: translateY(-3px); } }
        @keyframes attackThrust { 0% { transform: translateX(0); } 50% { transform: translateX(30px); } 100% { transform: translateX(0); } }

        #monster-wrapper { right: 15%; z-index: 9; transition: filter 0.1s; }
        .monster-idle { animation: monsterFloat 1.5s infinite ease-in-out; }
        .monster-hit { animation: hitShake 0.2s; filter: brightness(5) sepia(1) saturate(5) hue-rotate(-50deg) !important; }
        @keyframes monsterFloat { 50% { transform: translateY(-5px) scale(1.05); } }
        @keyframes hitShake { 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .hp-bar-container {
            position: absolute; bottom: 85px; right: 15%; width: 80px; height: 6px;
            background: #333; border: 2px solid #000;
        }
        .hp-fill { height: 100%; background: #e74c3c; width: 100%; transition: width 0.1s; }

        /* --- í•˜ë‹¨ ê²Œì„ ì˜ì—­ --- */
        #game-area {
            flex: 1; display: flex; flex-direction: column; padding: 10px;
            background: var(--panel-bg); box-shadow: inset 0 5px 10px rgba(0,0,0,0.3);
        }
        .stats-bar {
            display: flex; justify-content: space-between; margin-bottom: 10px;
            font-size: 0.8rem; color: var(--gold); text-shadow: 1px 1px 0 #000;
        }
        #grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;
            flex: 1; max-width: 500px; margin: 0 auto; width: 100%; aspect-ratio: 1;
        }
        .slot {
            background: var(--slot-bg); border: 2px solid #111; border-radius: 4px;
            position: relative; display: flex; justify-content: center; align-items: center;
        }
        .item {
            font-size: 2rem; cursor: grab; user-select: none; position: absolute; z-index: 5;
            filter: drop-shadow(2px 2px 0 #000); transition: transform 0.1s;
        }
        .item.dragging { z-index: 100; pointer-events: none; transform: scale(1.2); opacity: 0.8; }
        
        .controls { margin-top: 10px; text-align: center; }
        button {
            background: var(--accent); color: white; border: 4px solid #c0392b; padding: 15px;
            font-family: var(--pixel-font); font-size: 0.9rem; width: 100%; max-width: 500px;
            box-shadow: 0 4px 0 #96281b; cursor: pointer;
        }
        button:active { transform: translateY(4px); box-shadow: none; }
        button:disabled { background: #7f8c8d; border-color: #555; box-shadow: none; color: #ccc; cursor: not-allowed; }

        .dmg-text {
            position: absolute; color: #fff; font-weight: bold; font-size: 1.2rem;
            text-shadow: 2px 2px 0 #000; pointer-events: none; animation: floatUp 0.8s forwards; z-index: 30;
        }
        @keyframes floatUp { 100% { opacity: 0; transform: translateY(-40px) scale(1.5); } }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:white; text-shadow:4px 4px 0 #000; margin-bottom:30px; text-align:center; line-height:1.5;">PIXEL<br>KNIGHT</h1>
        <button class="start-btn" onclick="startGame()">GAME START</button>
        <p style="color:#ccc; margin-top:20px; font-size:0.7rem;">SOUND ON ğŸ”Š</p>
    </div>

    <div id="sound-toggle" onclick="toggleMute()">ğŸ”Š</div>

    <div id="stage-area">
        <div class="sky-cloud"></div>
        <div class="ground"></div>
        <div class="stage-ui">
            <div>âš”ï¸ DPS: <span id="dps-display">0</span></div>
            <div>ğŸš© STAGE <span id="stage-num">1</span></div>
        </div>
        
        <div id="hero-wrapper" class="actor-wrapper hero-idle">
            <svg viewBox="0 0 12 12" shape-rendering="crispEdges">
                <rect x="5" y="0" width="2" height="1" fill="#e74c3c" />
                <rect x="4" y="1" width="4" height="3" fill="#95a5a6" />
                <rect x="5" y="2" width="2" height="1" fill="#000" />
                <rect x="3" y="4" width="6" height="4" fill="#34495e" />
                <rect x="5" y="5" width="2" height="2" fill="#bdc3c7" />
                <rect x="4" y="8" width="1" height="3" fill="#2c3e50" />
                <rect x="7" y="8" width="1" height="3" fill="#2c3e50" />
                <rect x="9" y="5" width="1" height="1" fill="#8e44ad" />
                <rect x="9" y="2" width="1" height="3" fill="#ecf0f1" />
                <rect x="2" y="5" width="2" height="3" fill="#f1c40f" />
            </svg>
        </div>

        <div id="monster-wrapper" class="actor-wrapper monster-idle">
            <div class="hp-bar-container"><div id="monster-hp-bar" class="hp-fill"></div></div>
            <svg id="monster-svg" viewBox="0 0 12 12" shape-rendering="crispEdges">
                <rect x="2" y="4" width="8" height="7" fill="currentColor" />
                <rect x="3" y="3" width="6" height="1" fill="currentColor" />
                <rect x="3" y="5" width="2" height="2" fill="#fff" />
                <rect x="7" y="5" width="2" height="2" fill="#fff" />
                <rect x="4" y="6" width="1" height="1" fill="#000" />
                <rect x="8" y="6" width="1" height="1" fill="#000" />
                <rect x="5" y="9" width="2" height="1" fill="#330000" opacity="0.5" />
            </svg>
        </div>
    </div>

    <div id="game-area">
        <div class="stats-bar">
            <span>ğŸ’° <span id="gold-display">0</span></span>
        </div>
        <div id="grid"></div>
        <div class="controls">
            <button id="buy-btn">ë¬´ê¸° ë½‘ê¸° (10 G)</button>
            <div style="margin-top:8px; font-size:0.6rem; color:#7f8c8d; cursor:pointer;" onclick="resetData()">[ë°ì´í„° ì´ˆê¸°í™”]</div>
        </div>
    </div>

    <script>
        // --- ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ (Web Audio API) ---
        let audioCtx = null;
        let isMuted = false;
        let bgmInterval = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                playBgm();
            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('sound-toggle').innerText = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            if (isMuted && audioCtx) audioCtx.suspend();
            if (!isMuted && audioCtx) audioCtx.resume();
        }

        // 8ë¹„íŠ¸ íš¨ê³¼ìŒ ìƒì„±ê¸°
        function playSfx(type) {
            if (!audioCtx || isMuted) return;
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'hit') {
                // íƒ€ê²©ìŒ: ë…¸ì´ì¦ˆ ëŠë‚Œì˜ ì‚¬ê°íŒŒ (ë†’ì€ìŒ -> ë‚®ì€ìŒ ê¸‰ê²© í•˜ê°•)
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'merge') {
                // í•©ì¹˜ê¸°: ë ë¡± (ìƒìŠ¹ìŒ)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(600, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'buy') {
                // êµ¬ë§¤: ë™ì „ ì†Œë¦¬ (ë‘ ë²ˆ íŒ…)
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, now);
                gainNode.gain.setValueAtTime(0.05, now);
                osc.start(now);
                osc.stop(now + 0.05);
                
                setTimeout(() => {
                    const osc2 = audioCtx.createOscillator();
                    const gain2 = audioCtx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioCtx.destination);
                    osc2.type = 'triangle';
                    osc2.frequency.setValueAtTime(1200, now + 0.1);
                    gain2.gain.setValueAtTime(0.05, now + 0.1);
                    gain2.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc2.start(now + 0.1);
                    osc2.stop(now + 0.3);
                }, 50);
            }
        }

        // ê°„ë‹¨í•œ BGM ì‹œí€€ì„œ
        function playBgm() {
            if (bgmInterval) clearInterval(bgmInterval);
            
            let noteIndex = 0;
            // C Major Arpeggio Style Pattern
            const notes = [261.63, 329.63, 392.00, 523.25, 392.00, 329.63]; 
            
            bgmInterval = setInterval(() => {
                if (!audioCtx || isMuted || audioCtx.state === 'suspended') return;

                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);

                osc.type = 'triangle';
                const freq = notes[noteIndex % notes.length];
                // ë² ì´ìŠ¤ ìŒ ì¶”ê°€ ëŠë‚Œìœ¼ë¡œ ë‚®ê²Œ ê¹”ê¸°
                osc.frequency.setValueAtTime(freq / 2, audioCtx.currentTime); 
                
                gain.gain.setValueAtTime(0.02, audioCtx.currentTime); // ë³¼ë¥¨ ë§¤ìš° ì‘ê²Œ (ë°°ê²½ìŒ)
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);

                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.4);

                noteIndex++;
            }, 500); // 0.5ì´ˆë§ˆë‹¤ ìŒ ì¬ìƒ
        }


        // --- ê¸°ì¡´ ê²Œì„ ë¡œì§ ---
        const WEAPONS = ['ğŸ—¡ï¸', 'âš”ï¸', 'ğŸ¹', 'ğŸª“', 'ğŸ”±', 'ğŸ”¥', 'ğŸ’€', 'ğŸ’', 'ğŸŒ™', 'ğŸŒŸ'];
        const GRID_SIZE = 16;
        let game = { gold: 0, inventory: Array(GRID_SIZE).fill(null), buyCount: 0, stage: 1, monsterHp: 20, maxHp: 20 };
        let isGameStarted = false;

        const gridEl = document.getElementById('grid');
        const goldEl = document.getElementById('gold-display');
        const dpsEl = document.getElementById('dps-display');
        const stageEl = document.getElementById('stage-num');
        const buyBtn = document.getElementById('buy-btn');
        const heroWrapper = document.getElementById('hero-wrapper');
        const monsterWrapper = document.getElementById('monster-wrapper');
        const hpBarEl = document.getElementById('monster-hp-bar');
        const stageArea = document.getElementById('stage-area');

        // ê²Œì„ ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰
        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            initAudio();
            isGameStarted = true;
            requestAnimationFrame(combatLoop);
        }

        function initGrid() {
            gridEl.innerHTML = '';
            for (let i = 0; i < GRID_SIZE; i++) {
                let slot = document.createElement('div');
                slot.className = 'slot';
                slot.dataset.index = i;
                gridEl.appendChild(slot);
            }
        }

        function getWeaponDamage(level) { return Math.floor(10 * Math.pow(2.1, level)); }
        function getTotalDPS() { return game.inventory.reduce((sum, lvl) => (lvl !== null ? sum + getWeaponDamage(lvl) : sum), 0); }
        function getBuyCost() { return Math.floor(10 * Math.pow(1.15, game.buyCount)); }
        function getMonsterMaxHp(stage) { return Math.floor(30 * Math.pow(1.25, stage - 1)); }

        function updateMonsterAppearance() {
            const hue = (game.stage * 45) % 360; 
            monsterWrapper.style.color = `hsl(${hue}, 70%, 60%)`;
            document.getElementById('monster-svg').style.fill = `hsl(${hue}, 70%, 60%)`;
        }

        function render() {
            goldEl.innerText = Math.floor(game.gold).toLocaleString();
            dpsEl.innerText = getTotalDPS().toLocaleString();
            stageEl.innerText = game.stage;

            const cost = getBuyCost();
            buyBtn.innerText = `ë¬´ê¸° ë½‘ê¸° (${cost.toLocaleString()} G)`;
            buyBtn.disabled = game.gold < cost;

            const slots = document.querySelectorAll('.slot');
            slots.forEach((slot, idx) => {
                if (slot.querySelector('.dragging')) return;
                slot.innerHTML = '';
                const level = game.inventory[idx];
                if (level !== null) {
                    const el = document.createElement('div');
                    el.className = 'item';
                    el.innerText = WEAPONS[level] || 'ğŸ‘‘';
                    addDragEvents(el);
                    slot.appendChild(el);
                }
            });
            saveData();
        }

        let lastTime = 0;
        function combatLoop(timestamp) {
            if (!isGameStarted) return;
            if (!lastTime) lastTime = timestamp;
            if (timestamp - lastTime >= 1000) { // 1ì´ˆë§ˆë‹¤ ê³µê²©
                const dps = getTotalDPS();
                if (dps > 0) attackMonster(dps);
                lastTime = timestamp;
            }
            requestAnimationFrame(combatLoop);
        }

        function attackMonster(damage) {
            heroWrapper.classList.remove('hero-attack');
            void heroWrapper.offsetWidth; 
            heroWrapper.classList.add('hero-attack');
            
            // íƒ€ê²© ì‚¬ìš´ë“œ ì¬ìƒ
            playSfx('hit');

            game.monsterHp -= damage;
            updateHpBar();
            
            showDamageText(damage);
            monsterWrapper.classList.add('monster-hit');
            setTimeout(() => monsterWrapper.classList.remove('monster-hit'), 200);

            if (game.monsterHp <= 0) {
                const reward = Math.floor(game.maxHp * 0.4);
                game.gold += reward;
                game.stage++;
                game.maxHp = getMonsterMaxHp(game.stage);
                game.monsterHp = game.maxHp;
                updateMonsterAppearance();
                updateHpBar();
                render();
            }
        }

        function updateHpBar() {
            const pct = Math.max(0, (game.monsterHp / game.maxHp) * 100);
            hpBarEl.style.width = pct + '%';
        }

        function showDamageText(dmg) {
            const el = document.createElement('div');
            el.className = 'dmg-text';
            el.innerText = `-${dmg}`;
            const randX = (Math.random() - 0.5) * 40;
            el.style.left = `calc(85% + ${randX}px)`; 
            el.style.top = '50%';
            stageArea.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ---
        let dragged = null, startIdx = null, offsets = { x:0, y:0 };
        function addDragEvents(el) {
            el.addEventListener('mousedown', startDrag);
            el.addEventListener('touchstart', startDrag, {passive: false});
        }
        function startDrag(e) {
            e.preventDefault(); dragged = e.target;
            startIdx = parseInt(dragged.parentElement.dataset.index);
            const cX = e.touches ? e.touches[0].clientX : e.clientX;
            const cY = e.touches ? e.touches[0].clientY : e.clientY;
            const r = dragged.getBoundingClientRect();
            offsets.x = cX - r.left; offsets.y = cY - r.top;
            dragged.classList.add('dragging');
            dragged.style.position = 'fixed';
            dragged.style.left = (cX - offsets.x) + 'px'; dragged.style.top = (cY - offsets.y) + 'px';
            dragged.style.width = r.width + 'px'; dragged.style.height = r.height + 'px';
            document.addEventListener('mousemove', moveDrag); document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', moveDrag, {passive:false}); document.addEventListener('touchend', endDrag);
        }
        function moveDrag(e) {
            if(!dragged) return; e.preventDefault();
            const cX = e.touches ? e.touches[0].clientX : e.clientX;
            const cY = e.touches ? e.touches[0].clientY : e.clientY;
            dragged.style.left = (cX - offsets.x) + 'px'; dragged.style.top = (cY - offsets.y) + 'px';
        }
        function endDrag(e) {
            if(!dragged) return;
            const cX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const cY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            dragged.hidden = true;
            const elem = document.elementFromPoint(cX, cY);
            dragged.hidden = false;
            const slot = elem ? elem.closest('.slot') : null;
            if(slot) handleMerge(startIdx, parseInt(slot.dataset.index));
            dragged.remove(); dragged = null;
            document.removeEventListener('mousemove', moveDrag); document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', moveDrag); document.removeEventListener('touchend', endDrag);
            render();
        }
        function handleMerge(from, to) {
            if(from === to) return;
            const i1 = game.inventory[from], i2 = game.inventory[to];
            if(i2 === null) { game.inventory[to] = i1; game.inventory[from] = null; }
            else if(i1 === i2) {
                if(i1 < WEAPONS.length - 1) { 
                    game.inventory[to] = i1 + 1; game.inventory[from] = null; 
                    playSfx('merge'); // ë¨¸ì§€ ì‚¬ìš´ë“œ
                }
                else { game.inventory[to] = i1; game.inventory[from] = i2; }
            } else { game.inventory[to] = i1; game.inventory[from] = i2; }
        }

        buyBtn.addEventListener('click', () => {
            const cost = getBuyCost();
            const empty = game.inventory.findIndex(x => x === null);
            if(game.gold >= cost && empty !== -1) {
                game.gold -= cost; game.inventory[empty] = 0; game.buyCount++;
                playSfx('buy'); // êµ¬ë§¤ ì‚¬ìš´ë“œ
                render();
            }
        });

        function saveData() { localStorage.setItem('knightMergeSave', JSON.stringify(game)); }
        function loadData() {
            const s = localStorage.getItem('knightMergeSave');
            if(s) game = JSON.parse(s); else game.gold = 100;
            updateMonsterAppearance();
        }
        function resetData() { if(confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.removeItem('knightMergeSave'); location.reload(); } }

        initGrid();
        loadData();
        render();
        // combatLoopëŠ” Start ë²„íŠ¼ í´ë¦­ í›„ ì‹¤í–‰ë¨
    </script>
</body>
</html>